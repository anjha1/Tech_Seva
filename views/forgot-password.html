<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - TechSeva</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Auth CSS -->
    <link rel="stylesheet" href="/css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <img src="https://placehold.co/90x90/3498DB/FFFFFF/png?text=TS" alt="Service Logo" style="width: 70px; height: 70px; margin-bottom: 10px;">
            <h1>Forgot Password</h1>
            <p>Enter your email to reset your password</p>
        </div>

        <!-- Forgot Password Email Form -->
        <form id="forgot-password-email-form" class="auth-form active">
            <div class="form-group">
                <label for="forgot-password-email">Email:</label>
                <input type="email" id="forgot-password-email" name="email" placeholder="Enter your registered email" required>
            </div>
            <button type="submit" class="auth-btn" id="send-reset-otp-btn">Send Reset OTP</button>
            <div class="auth-footer">
                <a href="/login" class="forgot-password">Back to Login</a>
            </div>
        </form>

        <!-- Reset Password Form (Hidden by default) -->
        <form id="reset-password-form" class="auth-form" style="display: none;">
            <p id="reset-otp-sent-message">We've sent an OTP to <span id="reset-email-display"></span>. Please enter it below.</p>
            <div class="otp-input">
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
                <input type="text" maxlength="1" class="otp-digit reset-otp-digit" pattern="\d*" required>
            </div>
            <div class="form-group password-input">
                <label for="new-password">New Password:</label>
                <input type="password" id="new-password" name="newPassword" placeholder="Min 8 characters" minlength="8" required>
                <i class="fas fa-eye toggle-password"></i>
            </div>
            <div class="form-group password-input">
                <label for="confirm-new-password">Confirm New Password:</label>
                <input type="password" id="confirm-new-password" name="confirmNewPassword" placeholder="Confirm new password" minlength="8" required>
                <i class="fas fa-eye toggle-confirm-password"></i>
            </div>
            <button type="submit" class="auth-btn" id="submit-reset-password-btn">Reset Password</button>
            <p class="resend-otp">Didn't receive OTP? <a href="javascript:void(0)" id="resend-reset-otp-btn">Resend</a></p>
        </form>
    </div>

    <!-- Message Box Placeholder -->
    <div id="message-container"></div>

    <script>
        // Function to display messages (success/error)
        const showMessage = (message, type = 'success') => {
            const messageContainer = document.getElementById('message-container');
            if (!messageContainer) return;

            // Remove any existing messages
            messageContainer.innerHTML = '';

            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}`;
            messageBox.textContent = message;
            messageContainer.appendChild(messageBox);
            messageContainer.style.display = 'block';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.remove();
                    if (!messageContainer.children.length) {
                        messageContainer.style.display = 'none';
                    }
                }, 500);
            }, 4500);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const forgotPasswordEmailForm = document.getElementById('forgot-password-email-form');
            const forgotPasswordEmailInput = document.getElementById('forgot-password-email');
            const sendResetOtpBtn = document.getElementById('send-reset-otp-btn');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const resetEmailDisplay = document.getElementById('reset-email-display');
            const resetOtpDigits = resetPasswordForm.querySelectorAll('.reset-otp-digit');
            const newPasswordInput = document.getElementById('new-password');
            const confirmNewPasswordInput = document.getElementById('confirm-new-password');
            const submitResetPasswordBtn = document.getElementById('submit-reset-password-btn');
            const resendResetOtpBtn = document.getElementById('resend-reset-otp-btn');

            // Send Reset OTP Form Submission
            forgotPasswordEmailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showMessage('', null);
                const email = forgotPasswordEmailInput.value.trim();
                if (!email) {
                    showMessage('Please enter your email address.', 'error');
                    return;
                }

                sendResetOtpBtn.disabled = true;
                sendResetOtpBtn.textContent = 'Sending OTP...';

                try {
                    const response = await fetch('/send-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, type: 'password_reset' })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        sessionStorage.setItem('pendingResetEmail', email);
                        resetEmailDisplay.textContent = email;
                        forgotPasswordEmailForm.style.display = 'none';
                        resetPasswordForm.style.display = 'block';
                        showMessage(result.message, 'success');
                        resetOtpDigits.forEach(input => input.value = '');
                        resetOtpDigits[0].focus();
                    } else {
                        showMessage(result.message || 'Failed to send reset OTP.', 'error');
                    }
                } catch (error) {
                    console.error('Send Reset OTP Error:', error);
                    showMessage('Network error while sending reset OTP. Please try again.', 'error');
                } finally {
                    sendResetOtpBtn.disabled = false;
                    sendResetOtpBtn.textContent = 'Send Reset OTP';
                }
            });

            // OTP Input focus management
            resetOtpDigits.forEach((digitInput, index) => {
                digitInput.addEventListener('input', () => {
                    if (digitInput.value.length === 1 && index < resetOtpDigits.length - 1) {
                        resetOtpDigits[index + 1].focus();
                    }
                });

                digitInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && digitInput.value === '' && index > 0) {
                        resetOtpDigits[index - 1].focus();
                    }
                });
            });

            // Resend Reset OTP
            resendResetOtpBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                showMessage('', null);

                const email = sessionStorage.getItem('pendingResetEmail');
                if (!email) {
                    showMessage('No email found to resend OTP. Please restart forgot password process.', 'error');
                    return;
                }

                resendResetOtpBtn.disabled = true;
                resendResetOtpBtn.textContent = 'Sending...';

                try {
                    const response = await fetch('/send-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, type: 'password_reset' })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message || 'Failed to resend OTP.', 'error');
                    }
                } catch (error) {
                    console.error('Resend Reset OTP error:', error);
                    showMessage('Network error while resending OTP.', 'error');
                } finally {
                    resendResetOtpBtn.disabled = false;
                    resendResetOtpBtn.textContent = 'Resend';
                }
            });

            // Submit Reset Password Form
            resetPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showMessage('', null);

                const email = sessionStorage.getItem('pendingResetEmail');
                const enteredOtp = Array.from(resetOtpDigits).map(input => input.value).join('');
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;

                if (!email || !enteredOtp || !newPassword || !confirmNewPassword) {
                    showMessage('All fields are required.', 'error');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    showMessage('New passwords do not match.', 'error');
                    return;
                }
                if (newPassword.length < 8) {
                    showMessage('New password must be at least 8 characters.', 'error');
                    return;
                }
                if (enteredOtp.length !== 6) {
                    showMessage('Please enter the complete 6-digit OTP.', 'error');
                    return;
                }

                submitResetPasswordBtn.disabled = true;
                submitResetPasswordBtn.textContent = 'Resetting...';

                try {
                    const response = await fetch('/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, otp: enteredOtp, newPassword })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        showMessage(result.message, 'success');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else {
                        showMessage(result.message || 'Failed to reset password.', 'error');
                    }
                } catch (error) {
                    console.error('Reset Password Error:', error);
                    showMessage('Network error during password reset. Please try again.', 'error');
                } finally {
                    submitResetPasswordBtn.disabled = false;
                    submitResetPasswordBtn.textContent = 'Reset Password';
                }
            });

            // Password Toggle Logic
            document.querySelectorAll('.toggle-password, .toggle-confirm-password').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const passwordInput = toggle.previousElementSibling;
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.classList.toggle('fa-eye');
                    toggle.classList.toggle('fa-eye-slash');
                });
            });
        });
    </script>
</body>
</html>